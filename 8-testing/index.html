
<!doctype html>
  <head>
    <title> Testing |  RubyMotion Tutorial</title>
    <meta name="description" content="How to use RubyMotion's testing suite for functional and unit tests" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="robots" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="author" content="Clay Allsopp" />

    <meta property="og:title" content="RubyMotion Tutorial: Write iOS apps in Ruby" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="http://tutorial.rubymotion.jp/" />
    <meta property="og:image" content="http://i.imgur.com/mndCd.png" />
    <meta property="og:site_name" content="RubyMotion Tutorial" />
    <meta property="og:description" content="Learn to write iOS apps in Ruby.">

    <meta name=viewport content="width=device-width, initial-scale=1.0,maximum-scale = 1.0">

    <link rel=stylesheet href='/css/bootstrap.min.css'>
    <link rel=stylesheet href='/css/bootstrap-responsive.min.css'>
    <link rel=stylesheet href='/css/blog/pygments.css'>
    <link rel=stylesheet href='/css/patch.css'>
    <link rel=stylesheet href='/css/chapter.css'>
    

  </head>

  <body>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <a id="fork-me" href="https://github.com/RubyMotionJP/rubymotion-tutorial" target="_blank">Fork me on GitHub</a>
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span2" id="derp">
            <nav>
            <ul class="nav nav-list">
              <li class="nav-header" id="chapter-nav-btn">
                Chapters <i class="icon-chevron-up" id="chapter-nav-chevron"></i>
              </li>
            </ul>
            <ul class="nav nav-list" id="chapter-nav">
              
                <li >
                  <a href="/0-in-motion">In Motion</a>
                </li>
              
                <li >
                  <a href="/1-hello-motion">Hello Motion</a>
                </li>
              
                <li >
                  <a href="/2-views">Views</a>
                </li>
              
                <li >
                  <a href="/3-controllers">Controllers</a>
                </li>
              
                <li >
                  <a href="/4-containers">Containers</a>
                </li>
              
                <li >
                  <a href="/5-tables">Tables</a>
                </li>
              
                <li >
                  <a href="/6-animations">Animations</a>
                </li>
              
                <li >
                  <a href="/7-models">Models</a>
                </li>
              
                <li  class="active" >
                  <a href="/8-testing">Testing</a>
                </li>
              
                <li >
                  <a href="/9-http">HTTP</a>
                </li>
              
                <li >
                  <a href="/10-api-driven-example">API Driven Example</a>
                </li>
              
            </ul>
            <ul class="nav nav-list">
              <li class="divider"></li>
              <li><a href="/">Home</a></li>
              <li><a href="https://github.com/RubyMotionJP/rubymotion-tutorial">Source</a></li>
              <li class="divider"></li>
            </ul>
          </nav>
        </div>
        <div class="span10" id="content">
          <div id="main">
            <h1 id="toc_0">Testing</h1>

<p>これまで取り上げてきたすべてのものは、Objective-C と Ruby のごく一般的なものでした。もちろん両者は構文が異なり、Ruby と Objective-C それぞれのメリットについて一日中論争できることでしょう。しかし、これまで扱ってきたものは通常の iOS のツールを使用しており、パフォーマンスについては同等です。それでは、RubyMotion 独自のものについて紹介しましょう。</p>

<p>自動テストは本当に最高なものです。ここでは私は押し売りはしませんが(私よりもそれにふさわしい方々がいます)、ソフトウェアを構築する際に、テストを書いて疑う余地なくコードの整合性を検証することはかなり生産的でしょう(常にそうではないですが、良い考えでしょう)。もし将来あるいは現在に何かが壊れている場合、すぐにそれを知ることができます。それはなんてクールなことでしょうか？</p>

<p>テストすることは素晴らしい考えだとみなさん賛成しますが、実際にテストを記述するときに多くのエンジニアは当然のことながら躊躇します。それには魅力的な機能も計測可能なパフォーマンス向上もありません。将来への保証です。とりわけ短期的なプロジェクトでは、テストにおける工数はもっともインパクトのないものと言うのは簡単です。</p>

<p>さてどうしましょうか？できるだけ簡単に、途切れずに書けるようなテスト環境を作るのです。</p>

<p>Ruby コミュニティーにはテストの文化が根付いており、プログラマーのオーバーヘッドがごくわずかな、非常に簡潔なテストプラクティスが確立されています。対照的に、Apple による Objective-C で書かれた iOS アプリのテスト自動化手法は JavaScript の記述を必要とします。Objective-C でテストを記述することができるサードパーティのライブラリもありますが、正直、RubyMotion のテストフレームワークはそれらをとても驚かせるものでしょう。</p>

<p>どれだけ簡単なのか見てみましょう。</p>

<h2 id="toc_1">Unit Testing</h2>

<p>真新しい RubyMotion プロジェクトを <code>motion create Tests</code> で作成し、<code>cd</code> でプロジェクトへ移動しましょう。以前、<code>motion create</code> でデフォルトのフォルダが作成されることを書きましたが覚えてるでしょうか？ここでは、新しく <code>spec</code> を見ていくつもりです。</p>

<p>RubyMotion は <code>./spec</code> フォルダの <code>*.rb</code> ファイルの一つ一つからテストを読み込みます。RubyMotion アプリを作成したときに、<code>./spec/main_spec.rb</code> にデフォルトのテストが次のように作られます。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s2">&quot;Application &#39;Tests&#39;&quot;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="vi">@app</span> <span class="o">=</span> <span class="no">UIApplication</span><span class="o">.</span><span class="n">sharedApplication</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;has one window&quot;</span> <span class="k">do</span>
    <span class="vi">@app</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>少し時間を取ってすべての単語を本を読むように声に出して読み上げてみましょう。シンプルで表現力があるでしょう？<code>@app.windows.size.should == 1</code> は、「もし <code>.size</code> の値が 1 と等しくなければテストが失敗します」ということを <em>きっちり</em> 行います。</p>

<p><code>.should</code> は他のどのような種類のオブジェクトでも同様に動作します。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="vi">@app</span><span class="o">.</span><span class="n">nil?</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">false</span>

<span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">].</span><span class="n">should</span><span class="o">.</span><span class="n">not</span> <span class="o">==</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="o">]</span>

<span class="vi">@model</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">example_id</span>
</code></pre></div>
<p><code>describe</code> と <code>it</code> はテストの構造化に役に立ちます。これらの組み合わせを次のような文として読むことができます。&quot;&#39;Tests&#39; アプリケーションは一つの window があります&quot;。 <code>describe</code> ブロックにはたくさんの <code>it</code> を書くことができ、<code>it</code> にはたくさんの期待する値を書くことができます。<code>describe</code> ブロックは入れ子にすることもできます。</p>

<p>生成されたテストで最後に取り上げるのは <code>before</code> ブロックです。<code>before</code> ブロックのコードは各テストの事前に実行されます。オブジェクトをリセットしたり、テスト項目の状態を設定するのに適した場所です。</p>

<p>これらの楽しいおもちゃを実際にどのように使うのでしょう？ Terminal で、<code>rake spec</code> を実行してみてください。Spec の実行用に、アプリケーションがビルドされます。</p>

<p><code>rake spec</code> を試してください。次のような、いくつかの結果を確認できます。</p>

<p><img src="images/1.png" alt="test failure"></p>

<p>うぉぉ、私たちのアプリケーションはウィンドウが無いようです。<code>AppDelegate</code> を修正してみましょう。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AppDelegate</span>
  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">applicationFrame</span><span class="p">)</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
  <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>再び <code>rake spec</code> を実行し、失敗が無いことを確認しましょう。</p>

<p><img src="images/2.png" alt="test pass"></p>

<p>今まさに、みなさんはバグを修正するために自動化されたテストをもちいました。</p>

<p>それはオブジェクトのプロパティの動作をテストする方法の要点です。特定のものが存在するか、または属性と等しいかをチェックするのに非常に便利です。ただ、イベントを引き起こすために、おそらく多くの特定の機能や内部機能を呼び出す必要があります。たとえば、タップしたばかりのボタンの属性が変更されたかを確認したい場合には、手動でボタンのコールバックを起動する必要があります。よりよい方法があったなら、、、</p>

<h2 id="toc_2">Functional Testing</h2>

<p>実はそれはあります。RubyMotion もまた、タップやスワイプのような UI イベントを引き起こして、その副作用を調査する機能テストについて素晴らしいサポートをしています。<code>button.callback.call</code> のように何かをする代わりに、<code>tap button</code> を使うことができます。すばらしいでしょ？</p>

<p>これら機能テストは素晴らしいものですが、単一の <code>UIViewController</code> をテストすることを意図しており、複数のコントローラを使うことはしません。</p>

<p>これを動作させるために、はじめに新しい <code>UIViewController</code> のサブクラスが必要となります。<code>./app/ButtonController.rb</code> を作成し、次のようにボタンとコールバックを用意します。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ButtonController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>
  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="k">super</span>

    <span class="vi">@button</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
    <span class="vi">@button</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Test me title!&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
    <span class="vi">@button</span><span class="o">.</span><span class="n">accessibilityLabel</span> <span class="o">=</span> <span class="s2">&quot;Test me!&quot;</span>
    <span class="vi">@button</span><span class="o">.</span><span class="n">sizeToFit</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@button</span><span class="p">)</span>

    <span class="vi">@button</span><span class="o">.</span><span class="n">addTarget</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span><span class="s1">&#39;tapped&#39;</span><span class="p">,</span> <span class="ss">forControlEvents</span><span class="p">:</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">tapped</span>
    <span class="nb">p</span> <span class="s2">&quot;I&#39;m tapped!&quot;</span>
    <span class="vi">@was_tapped</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>新しく登場した <code>accessibilityLabel</code> 以外は、ごく普通の <code>UIButton</code> パターンですね。</p>

<p><code>accessibilityLabel</code> はそれぞれの <code>UIView</code> で利用できる文字列を扱うプロパティです。デバイスの VoiceOver 機能を利用する際にオペレーティングシステムによって読み上げられるテキストとして使用されます (それなので、余計なもので埋めないでください)。なぜ、今これを導入するのでしょう？ RubyMotion の機能テストは <code>accessibilityLabel</code> をもとにビューを探します。メモリ上のどこかに存在するだけでなく、確実にテストするビューが階層へ追加されます。</p>

<p>最後に、<code>AppDelegate</code> でコントローラをウィンドウに関連づける必要があります。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>
  <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">applicationFrame</span><span class="p">)</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>

  <span class="vi">@view_controller</span> <span class="o">=</span> <span class="no">ButtonController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithNibName</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">bundle</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
  <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="vi">@view_controller</span>

  <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div>
<p><code>rake</code> を実行し、ボタンをタップすると Terminal に &quot;I&#39;m tapped!&quot; が表示されることを確認できます。では、変数が用意されてるか確認するために Test を書いてみましょう。</p>

<p><code>main_spec.rb</code> で、新しく <code>describe</code> ブロックを追加します。</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s2">&quot;button controller&quot;</span> <span class="k">do</span>
  <span class="n">tests</span> <span class="no">ButtonController</span>

  <span class="n">it</span> <span class="s2">&quot;changes instance variable when button is tapped&quot;</span> <span class="k">do</span>
    <span class="n">tap</span> <span class="s1">&#39;Test me!&#39;</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@was_tapped&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>いいね！私たちは新しい遊び道具を手に入れたようです。</p>

<p><code>tests &lt;class&gt;</code> は <code>describe</code> と指定された <code>UIViewController</code> のクラスを結びつけます。これは、<code>UIWindow</code> とテストするコントローラをインスタンス化します。テスト内でウィンドウとコントローラにそれぞれ <code>self.window</code> と <code>self.controller</code> でアクセスすることができます。これはテストの手続きを壊してしまうような、余計な UI やステートが無い状況を保証してくれます。</p>

<p>コントローラをテストするために Spec を用意し、<code>it</code> ブロックでアサーションを行います。もう一つの新しいおもちゃは <code>tap</code> です。 <code>tap</code> は最初の引数として <code>UIView</code> のオブジェクト <em>か</em> <code>accessibilityLabel</code> の値を取ります。<code>UIButton</code> と <code>UILabel</code> ではデフォルトで自分の <code>title</code> の値を <code>accessibilityLabel</code> として使用できます。今回の実装例では、テスト時、他のビューにアクセスするときの方法を示すためにデフォルトの挙動を用いませんでした。</p>

<p><code>tap</code> の他にも、<code>flick</code>,  <code>drag</code>, <code>pinch_close</code>, <code>pinch_open</code>, そして <code>rotate</code> も使うことができます。それぞれについて、RubyMotion の <a href="http://rubymotion.jp/RubyMotionDocumentation/articles/testing/#_view_events">full documentation</a> で確認してみてください。</p>

<p><code>rake spec</code> を実行し、実際に動作することを確認してみましょう。</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">2 specifications (2 requirements), 0 failures, 0 errors
</code></pre></div>
<h2 id="toc_3">Wrapping Up</h2>

<p>私たちは RubyMotion で難なくテストを書くことができます。もし、みなさんがこれまでプロジェクトでテストを書かれていないのでしたら、今から始めない理由はありません。</p>

<p>今日はテストについてどんなことを学んだでしょう？</p>

<ul>
<li>RubyMotion は <code>./spec</code> ディレクトリからテストを読み込みます。</li>
<li>テストは <code>describe</code> と <code>it</code> ブロックの集まりです。これらはラベルを引数に取り、同じようなテストをグループ分けするのに役に立ちます。</li>
<li><code>&lt;any object&gt;.should</code> は値が等しいかチェックする際に用います。 例 : <code>greeting.should == &quot;hello&quot;</code></li>
<li><code>UIViewController</code> には機能テストがあり、<code>tap</code> や <code>pinch</code> のようなイベントをシミュレートしてくれます。<code>describe</code> ブロックで、これらの機能を有効にするために <code>tests &lt;controller class&gt;</code> を用います。</li>
<li><code>tap &lt;accessibility label&gt;</code> は、ビューに設定した <code>accessibilityLabel</code> プロパティを引数に設定し、<code>tap</code> をコードから実行します。</li>
</ul>

<p><a href="/9-http">次の章は HTTP リクエストを実行する方法です！</a></p>

          </div>
          <hr />
          <h2>Like it?<small id="spread"> Spread the word</small></h2>
          <div id="social">
            <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

            <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://tutorial.rubymotion.jp" data-text="RubyMotion Tutorial: Make iOS Apps With Ruby" data-size="large" data-related="rubymotionjp" data-count="none">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

            <div class="fb-like" data-href="http://tutorial.rubymotion.jp/" data-send="true" data-width="450" data-show-faces="true"></div>
          </div>
          <hr />
        </div>
      </div>
    </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  <script src='http://clayallsopp.github.com/rubymotion-tutorial/js/bootstrap.min.js' type="text/javascript"></script>
  <script src='http://clayallsopp.github.com/rubymotion-tutorial/js/chapters.js' type="text/javascript"></script>
  </body>
</html>
