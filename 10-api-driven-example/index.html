
<!doctype html>
  <head>
    <title> API Driven Example |  RubyMotion Tutorial</title>
    <meta name="description" content="A complete RubyMotion example app using HTTP to access a remote API" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="robots" content="all" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="author" content="Clay Allsopp" />

    <meta property="og:title" content="RubyMotion Tutorial: Write iOS apps in Ruby" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="http://tutorial.rubymotion.jp/" />
    <meta property="og:image" content="http://i.imgur.com/mndCd.png" />
    <meta property="og:site_name" content="RubyMotion Tutorial" />
    <meta property="og:description" content="Learn to write iOS apps in Ruby.">

    <meta name=viewport content="width=device-width, initial-scale=1.0,maximum-scale = 1.0">

    <link rel=stylesheet href='/css/bootstrap.min.css'>
    <link rel=stylesheet href='/css/bootstrap-responsive.min.css'>
    <link rel=stylesheet href='/css/blog/pygments.css'>
    <link rel=stylesheet href='/css/patch.css'>
    <link rel=stylesheet href='/css/chapter.css'>
    

  </head>

  <body>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <a id="fork-me" href="https://github.com/RubyMotionJP/rubymotion-tutorial" target="_blank">Fork me on GitHub</a>
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span2" id="derp">
            <nav>
            <ul class="nav nav-list">
              <li class="nav-header" id="chapter-nav-btn">
                Chapters <i class="icon-chevron-up" id="chapter-nav-chevron"></i>
              </li>
            </ul>
            <ul class="nav nav-list" id="chapter-nav">
              
                <li >
                  <a href="/0-in-motion">In Motion</a>
                </li>
              
                <li >
                  <a href="/1-hello-motion">Hello Motion</a>
                </li>
              
                <li >
                  <a href="/2-views">Views</a>
                </li>
              
                <li >
                  <a href="/3-controllers">Controllers</a>
                </li>
              
                <li >
                  <a href="/4-containers">Containers</a>
                </li>
              
                <li >
                  <a href="/5-tables">Tables</a>
                </li>
              
                <li >
                  <a href="/6-animations">Animations</a>
                </li>
              
                <li >
                  <a href="/7-models">Models</a>
                </li>
              
                <li >
                  <a href="/8-testing">Testing</a>
                </li>
              
                <li >
                  <a href="/9-http">HTTP</a>
                </li>
              
                <li  class="active" >
                  <a href="/10-api-driven-example">API Driven Example</a>
                </li>
              
            </ul>
            <ul class="nav nav-list">
              <li class="divider"></li>
              <li><a href="/">Home</a></li>
              <li><a href="https://github.com/RubyMotionJP/rubymotion-tutorial">Source</a></li>
              <li class="divider"></li>
            </ul>
          </nav>
        </div>
        <div class="span10" id="content">
          <div id="main">
            <h1 id="toc_0">APIドリブン例：Colr</h1>

<p>私達は <a href="http://www.colr.org/api.html">Colr JSON API</a> のフロントエンドを構築します．ユーザーは 16 進コード ( 例: &quot;#3B5998&quot;) で色を入力することができ，その色に Colr ユーザーがどういったタグを割り当てているか見ることができます．もし特筆すべき新しいものだと感じた場合，新しいタグを追加できます！</p>

<p>大まかな設計について話しましょう．私達には 2 つのコントローラが必要です: 一つは検索のため，もう一つは色のため．それらはトップレベルのコントローラである <code>UINavigationController</code> の内部にラップされるべきです．<code>Color</code> や <code>Tag</code> といった，いくつかのモデルもまた必要になるでしょう．正直に言うと，私達のアプリは Dribbble の次のトップ記事にはならないでしょうけれども，まあとにかく動きはするでしょう．</p>

<h2 id="toc_1">セットアップ</h2>

<p><code>motion create Colr</code> でプロジェクトのセットアップをし，<code>require &#39;bubble-wrap&#39;</code> を <code>Rakefile</code> に追加します．適切な設定を行ったら，<code>./app</code> の <em>配下</em> にディレクトリを作成します． <code>./app/models/</code> 及び <code>./app/controllers</code> ディレクトリです．</p>

<h2 id="toc_2">モデル</h2>

<p>まずモデルを掘り下げてみましょう．Colr API は JSON オブジェクトの形式で自身の色を返します :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">{
  &quot;timestamp&quot;: 1285886579,
  &quot;hex&quot;: &quot;ff00ff&quot;,
  &quot;id&quot;: 3976,
  &quot;tags&quot;: [{
    &quot;timestamp&quot;: 1108110851,
    &quot;id&quot;: 2583,
    &quot;name&quot;: &quot;fuchsia&quot;
  }]
}
</code></pre></div>
<p>そこで，私達の <code>Color</code> には <code>timestamp</code>， <code>hex</code>， <code>id</code>，および <code>tags</code> のプロパティが必要になります．特に，<code>tags</code> は <code>Tag</code> オブジェクトの has-many 関係を表しています．</p>

<p><code>./app/models/color.rb</code> を作成して，モデルのテンプレートを書き込んでください :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Color</span>
  <span class="no">PROPERTIES</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:timestamp</span><span class="p">,</span> <span class="ss">:hex</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:tags</span><span class="o">]</span>
  <span class="no">PROPERTIES</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">prop</span><span class="o">|</span>
    <span class="kp">attr_accessor</span> <span class="n">prop</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">hash</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="nb">hash</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="k">if</span> <span class="no">PROPERTIES</span><span class="o">.</span><span class="n">member?</span> <span class="n">key</span><span class="o">.</span><span class="n">to_sym</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">key</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</code></pre></div>
<p><code>PROPERTIES</code> のトリックを使うのはとても簡単です．でも <code>tags</code> 属性についてだけ，常に <code>Tag</code> の配列であることという特別な前提を強制することにします :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="o">.</span><span class="n">.</span><span class="o">.</span>

  <span class="k">def</span> <span class="nf">tags</span>
    <span class="vi">@tags</span> <span class="o">||=</span> <span class="o">[]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">tags</span><span class="o">=</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tags</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Hash</span>
      <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">collect</span> <span class="p">{</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span> <span class="no">Tag</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">tags</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">tag</span><span class="o">|</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Tag</span>
        <span class="k">raise</span> <span class="s2">&quot;Wrong class for attempted tag </span><span class="si">#{</span><span class="n">tag</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="p">}</span>

    <span class="vi">@tags</span> <span class="o">=</span> <span class="n">tags</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><code>#tags</code> getter は <code>tags</code> にまだ値が与えられていない場合でも配列を返すことを保証します．<code>#tags=</code> setter は，引数で渡された <code>tags</code> に含まれる全てのオブジェクトが <code>Tag</code> オブジェクトであることを保証します．でも，待って……まだ <code>Tag</code> クラスを書いていませんでした！</p>

<p><code>./app/models/tag.rb</code> を作成して開きましょう．上記の例からわかるように，API から返されたタグの形式は次のとおりです :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">{
  &quot;timestamp&quot;: 1108110851,
  &quot;id&quot;: 2583,
  &quot;name&quot;: &quot;fuchsia&quot;
}
</code></pre></div>
<p>そこで，素晴しい API に馴染むようなモデルとなるように <code>Tag</code> クラスを作りましょう．特別なオーバーライドはありません．この状態で十分動作します :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Tag</span>
  <span class="no">PROPERTIES</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:timestamp</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="o">]</span>
  <span class="no">PROPERTIES</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">prop</span><span class="o">|</span>
    <span class="kp">attr_accessor</span> <span class="n">prop</span>
  <span class="p">}</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">hash</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="nb">hash</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="k">if</span> <span class="no">PROPERTIES</span><span class="o">.</span><span class="n">member?</span> <span class="n">key</span><span class="o">.</span><span class="n">to_sym</span>
        <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">key</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2 id="toc_3">コントローラー</h2>

<p>今，私たちにはモデルがありますので，コントローラーを作り始めましょう．<code>./app/controllers/search_controller.rb</code> と <code>./app/controllers/color_controller.rb</code> を作ってください．さしあたって今は最低限の実装をすることにします :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">SearchController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>
  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="k">super</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Search&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div><div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ColorController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>
  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="k">super</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Color&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>そして <code>UIWindow</code> と <code>UINavigationController</code> を <code>AppDelegate</code> を使って画面上に表示します :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">AppDelegate</span>
  <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="ss">didFinishLaunchingWithOptions</span><span class="p">:</span><span class="n">launchOptions</span><span class="p">)</span>
    <span class="vi">@window</span> <span class="o">=</span> <span class="no">UIWindow</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="no">UIScreen</span><span class="o">.</span><span class="n">mainScreen</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

    <span class="vi">@search_controller</span> <span class="o">=</span> <span class="no">SearchController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithNibName</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">bundle</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
    <span class="vi">@navigation_controller</span> <span class="o">=</span> <span class="no">UINavigationController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithRootViewController</span><span class="p">(</span><span class="vi">@search_controller</span><span class="p">)</span>

    <span class="vi">@window</span><span class="o">.</span><span class="n">rootViewController</span> <span class="o">=</span> <span class="vi">@navigation_controller</span>
    <span class="vi">@window</span><span class="o">.</span><span class="n">makeKeyAndVisible</span>
    <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>私たちは以前にもこのようなものを見たことがあり，一度だけではないかもしれません．<code>rake</code> して質素なアプリを見てみましょう :</p>

<p><img src="images/0.png" alt="search title in app"></p>

<p>好調な出足ですね！<code>SearchController</code> を作り込んでいきましょう．</p>

<h2 id="toc_4">SearchController</h2>

<p>ユーザーから入力された 16 進数を検索するのに，<code>UITextField</code> という，今まで私たちが使ってこなかった新しいタイプの制御を使いましょう．ユーザが &quot; 検索 &quot; ボタンを押すと，適切な API リクエストを実行し，それが終了するまで UI をロックします．もし結果を見つけた場合，<code>ColorController</code> をプッシュします．そうではない場合，残念ながらアラートを表示します．よさそうな動きじゃないですか？</p>

<p>以下のようにして，ビューを <code>SearchController</code> の中にセットアップすることができます :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="k">super</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Search&quot;</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">whiteColor</span>

    <span class="vi">@text_field</span> <span class="o">=</span> <span class="no">UITextField</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">160</span><span class="p">,</span> <span class="mi">26</span><span class="o">]]</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s2">&quot;#abcabc&quot;</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">autocapitalizationType</span> <span class="o">=</span> <span class="no">UITextAutocapitalizationTypeNone</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">borderStyle</span> <span class="o">=</span> <span class="no">UITextBorderStyleRoundedRect</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span> <span class="vi">@text_field</span>

    <span class="vi">@search</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
    <span class="vi">@search</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Search&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
    <span class="vi">@search</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Loading&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateDisabled</span><span class="p">)</span>
    <span class="vi">@search</span><span class="o">.</span><span class="n">sizeToFit</span>
    <span class="vi">@search</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="no">CGPointMake</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="vi">@text_field</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">40</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span> <span class="vi">@search</span>
  <span class="k">end</span>
</code></pre></div>
<p>沢山ある具体的なポジション設定 (<code>self.view.frame.size.height / 2 - 100</code> など ) は，私が勘で決めて動作確認しただけで，魔法のようなことは何もしていません（残念です）．初めてみる設定がいくつかあります．<code>UIControlStateDisabled</code> は，もしボタンが <code>@search.enabled = false</code> の場合にどのように見えるかを示しており，<code>UITextBorderStyleRoundedRect</code> とは，<code>UITextField</code> の見栄えよいスタイルのことです．</p>

<p><code>rake</code> してインターフェースがどうなっているか確かめましょう :</p>

<p><img src="images/1.png" alt="search controller in app"></p>

<p>さてそろそろ幾つかのイベントにフックを仕掛けましょうか．私が <code>BubbleWrap</code> にはいくつか気の利いたラッパーがあると言ったのを覚えていますか？実のところ，<code>addTarget:action:forControlEvents</code> という扱いにくいシンタックスを置き換えるために，既に一度使っていますね．Ruby 風に書くことで，コードがどれだけ明確になるかみてみましょう :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span> <span class="vi">@search</span>

    <span class="vi">@search</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@search</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="vi">@text_field</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span>

      <span class="n">hex</span> <span class="o">=</span> <span class="vi">@text_field</span><span class="o">.</span><span class="n">text</span>
      <span class="c1"># chop off any leading #s</span>
      <span class="n">hex</span> <span class="o">=</span> <span class="n">hex</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="k">if</span> <span class="n">hex</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;#&quot;</span>

      <span class="no">Color</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">hex</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">color</span><span class="o">|</span>
        <span class="vi">@search</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="vi">@text_field</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div>
<p><code>when</code> 関数は，全ての <code>UIControl</code> サブクラス (<code>UIButton</code> もその一つです ) で利用可能であり，<code>UIControlEvent</code> のビットマスクを引数として取ります．リクエストの実行中，私たちは一時的に UI 要素を無効にします．</p>

<p>あれ……<code>Color.find</code> メソッドとは何でしょうか？ええと，URL リクエストはコントローラではなくモデルの中で扱う方がおすすめです．その方が，アプリの他の部分から，サーバーにある <code>Color</code> を取得しようとした時に，コードの重複がなくなります． <em>……この言葉が伏線となっていたことを，このとき私たちは知る由もなかった</em> ．</p>

<p>ともかく，<code>Color</code> クラスに静的メソッド <code>find</code> を追加しましょう :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Color</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="n">hex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="ss">BW</span><span class="p">:</span><span class="ss">:HTTP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://www.colr.org/json/color/</span><span class="si">#{</span><span class="n">hex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">response</span><span class="o">|</span>
      <span class="nb">p</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_str</span>
      <span class="c1"># for now, pass nil.</span>
      <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>変に見えますか？基本的な <code>HTTP.get</code> を使って，API URL 経由でサーバーからデータを取得します．<code>&amp;block</code> 表記を使うことで，この関数がブロックと一緒に使われることを明確に表すようにしています．このブロックは別の引数として明示的に渡されるわけではなく，メソッドの後に <code>do/end</code> を書くことで暗黙的に渡されます．<code>.call(some, variables)</code> の変数の数と順序は <code>do |some, variables|</code> に対応しています．</p>

<p>とにかく，<code>rake</code> して &quot;3B5998&quot; のような色を渡してみましょう．コンソールでは，このような出力が表示されるはずです :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">(main)&gt; &quot;{\&quot;colors\&quot;: [{\&quot;timestamp\&quot;: 1285886579, \&quot;hex\&quot;: \&quot;ff00ff\&quot;, \&quot;id\&quot;: 3976, \&quot;tags\&quot;: [{\&quot;timestamp\&quot;: 1108110851, \&quot;id\&quot;: 2583, \&quot;name\&quot;: \&quot;fuchsia\&quot;}, {\&quot;timestamp\&quot;: 1108110864, \&quot;id\&quot;: 3810, \&quot;name\&quot;: \&quot;magenta\&quot;}, {\&quot;timestamp\&quot;: 1108110870, \&quot;id\&quot;: 4166, \&quot;name\&quot;: \&quot;magic\&quot;}, {\&quot;timestamp\&quot;: 1108110851, \&quot;id\&quot;: 2626, \&quot;name\&quot;: \&quot;pink\&quot;}, {\&quot;timestamp\&quot;: 1240447803, \&quot;id\&quot;: 24479, \&quot;name\&quot;: \&quot;rgba8b24ff00ff\&quot;}, {\&quot;timestamp\&quot;: 1108110864, \&quot;id\&quot;: 3810, \&quot;name\&quot;: \&quot;magenta\&quot;}]}], \&quot;schemes\&quot;: [], \&quot;schemes_history\&quot;: {}, \&quot;success\&quot;: true, \&quot;colors_history\&quot;: {\&quot;ff00ff\&quot;: [{\&quot;d_count\&quot;: 0, \&quot;id\&quot;: \&quot;4166\&quot;, \&quot;a_count\&quot;: 1, \&quot;name\&quot;: \&quot;magic\&quot;}, {\&quot;d_count\&quot;: 0, \&quot;id\&quot;: \&quot;2626\&quot;, \&quot;a_count\&quot;: 1, \&quot;name\&quot;: \&quot;pink\&quot;}, {\&quot;d_count\&quot;: 0, \&quot;id\&quot;: \&quot;24479\&quot;, \&quot;a_count\&quot;: 1, \&quot;name\&quot;: \&quot;rgba8b24ff00ff\&quot;}, {\&quot;d_count\&quot;: 0, \&quot;id\&quot;: \&quot;3810\&quot;, \&quot;a_count\&quot;: 1, \&quot;name\&quot;: \&quot;magenta\&quot;}]}, \&quot;messages\&quot;: [], \&quot;new_color\&quot;: \&quot;ff00ff\&quot;}\n&quot;
</code></pre></div>
<p>こいつは……すごく…… JSON 風です．そうじゃないですか？( もしあなたが URL に /json/ が含まれていることに気付かなかったなら，JSON 「風」であると思ってくれるはず )．解析して普通の Ruby ハッシュにできたなら素晴しいですよね？</p>

<p>BubbleWrap が再び助けてくれます！私たちの気の利く友人は <code>BW::JSON.parse</code> という，名は体を表すようなメソッドを持っています．それを使って <code>Color.find</code> を更新しましょう :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find</span><span class="p">(</span><span class="n">hex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="ss">BW</span><span class="p">:</span><span class="ss">:HTTP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://www.colr.org/json/color/</span><span class="si">#{</span><span class="n">hex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">response</span><span class="o">|</span>
    <span class="n">result_data</span> <span class="o">=</span> <span class="ss">BW</span><span class="p">:</span><span class="ss">:JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">to_str</span><span class="p">)</span>
    <span class="n">color_data</span> <span class="o">=</span> <span class="n">result_data</span><span class="o">[</span><span class="s2">&quot;colors&quot;</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span>

    <span class="c1"># Colr will return a color with id == -1 if no color was found</span>
    <span class="n">color</span> <span class="o">=</span> <span class="no">Color</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">color_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
      <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">block</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>そして <code>SearchController</code> の中で，無効な色を取得した場合にコールバックが適切な扱いをできるようにします :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>

      <span class="no">Color</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">hex</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">color</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">color</span><span class="o">.</span><span class="n">nil?</span>
          <span class="vi">@search</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;None :(&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span> <span class="no">UIControlStateNormal</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="vi">@search</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Search&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span> <span class="no">UIControlStateNormal</span><span class="p">)</span>
          <span class="nb">self</span><span class="o">.</span><span class="n">open_color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="vi">@search</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="vi">@text_field</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">open_color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="nb">p</span> <span class="s2">&quot;Opening </span><span class="si">#{</span><span class="n">color</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
</code></pre></div>
<p>よさそうですね．JSON をパースして，存在しない/-1 の id を確認して，それに応じて UI を変更します :</p>

<p><img src="images/2.png" alt="search controller in app"></p>

<p>素晴らしい！<code>open_color</code> メソッドが動くように修正してみましょう．それは <code>ColorController</code> へ適切な色と共に push するべきで，今はこんな実装で埋めておきましょうか．</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">def</span> <span class="nf">open_color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">pushViewController</span><span class="p">(</span><span class="no">ColorController</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithColor</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="ss">animated</span><span class="p">:</span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<h2 id="toc_5">ColorController</h2>

<p><code>ColorController</code> のためにカスタムしたイニシャライザを使うようにしましょう．これらのカスタムイニシャライザは，常に最初にスーパークラスのイニシャライザ ( この場合は <code>initWithNibName:bundle:</code>) を呼ぶように設計されています．コントローラのビューには，二つの部分があります : 色のタグを表示するための <code>UITableView</code>，そして色の表示と新しいタグを追加する部分．新しいタグを追加したい場合，POSTリクエストが送信され，それに応じてデータが更新されます．</p>

<p>たくさんのことをしているように見えますね．一つずつ進めていきましょう．最初に，カスタムしたイニシャライザについてです :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">ColorController</span> <span class="o">&lt;</span> <span class="no">UIViewController</span>
  <span class="kp">attr_accessor</span> <span class="ss">:color</span>

  <span class="k">def</span> <span class="nf">initWithColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="n">initWithNibName</span><span class="p">(</span><span class="kp">nil</span><span class="p">,</span> <span class="ss">bundle</span><span class="p">:</span><span class="kp">nil</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
    <span class="nb">self</span>
  <span class="k">end</span>

  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</code></pre></div>
<p>iOS の SDK のイニシャライザをオーバーライドする場合は，次の 2 つのことを行う必要があります : あらかじめデザインされたイニシャライザを呼び出し，最後に <code>self</code> を返す．いつもの Ruby の <code>initialize</code> 関数は使用できません．ご注意あれ！</p>

<p>次にインターフェースを並べてみましょう :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="k">super</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">hex</span>

    <span class="c1"># A light grey background to separate the Tag table from the Color info</span>
    <span class="vi">@info_container</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">110</span><span class="o">]]</span>
    <span class="vi">@info_container</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span> <span class="vi">@info_container</span>

    <span class="c1"># A visual preview of the actual color</span>
    <span class="vi">@color_view</span> <span class="o">=</span> <span class="no">UIView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span> <span class="o">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="o">]]</span>
    <span class="c1"># String#to_color is another handy BubbbleWrap addition!</span>
    <span class="vi">@color_view</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="nb">String</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span><span class="o">.</span><span class="n">to_color</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span> <span class="vi">@color_view</span>

    <span class="c1"># Displays the hex code of our color</span>
    <span class="vi">@color_label</span> <span class="o">=</span> <span class="no">UILabel</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span> <span class="o">[[</span><span class="mi">110</span><span class="p">,</span> <span class="mi">30</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">]]</span>
    <span class="vi">@color_label</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">hex</span>
    <span class="vi">@color_label</span><span class="o">.</span><span class="n">sizeToFit</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span> <span class="vi">@color_label</span>

    <span class="c1"># Where we enter the new tag</span>
    <span class="vi">@text_field</span> <span class="o">=</span> <span class="no">UITextField</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span> <span class="o">[[</span><span class="mi">110</span><span class="p">,</span> <span class="mi">60</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">26</span><span class="o">]]</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s2">&quot;tag&quot;</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="no">UITextAlignmentCenter</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">autocapitalizationType</span> <span class="o">=</span> <span class="no">UITextAutocapitalizationTypeNone</span>
    <span class="vi">@text_field</span><span class="o">.</span><span class="n">borderStyle</span> <span class="o">=</span> <span class="no">UITextBorderStyleRoundedRect</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span> <span class="vi">@text_field</span>

    <span class="c1"># Tapping this adds the tag.</span>
    <span class="vi">@add</span> <span class="o">=</span> <span class="no">UIButton</span><span class="o">.</span><span class="n">buttonWithType</span><span class="p">(</span><span class="no">UIButtonTypeRoundedRect</span><span class="p">)</span>
    <span class="vi">@add</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Add&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateNormal</span><span class="p">)</span>
    <span class="vi">@add</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s2">&quot;Adding...&quot;</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateDisabled</span><span class="p">)</span>
    <span class="vi">@add</span><span class="o">.</span><span class="n">setTitleColor</span><span class="p">(</span><span class="no">UIColor</span><span class="o">.</span><span class="n">lightGrayColor</span><span class="p">,</span> <span class="ss">forState</span><span class="p">:</span><span class="no">UIControlStateDisabled</span><span class="p">)</span>
    <span class="vi">@add</span><span class="o">.</span><span class="n">sizeToFit</span>
    <span class="vi">@add</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="o">[[</span><span class="vi">@text_field</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="vi">@text_field</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="vi">@text_field</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">y</span><span class="o">]</span><span class="p">,</span>
                      <span class="vi">@add</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">]</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@add</span><span class="p">)</span>

    <span class="c1"># The table for our color&#39;s tags.</span>
    <span class="n">table_frame</span> <span class="o">=</span> <span class="o">[[</span><span class="mi">0</span><span class="p">,</span> <span class="vi">@info_container</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="o">]</span><span class="p">,</span>
                  <span class="o">[</span><span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="vi">@info_container</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="nb">self</span><span class="o">.</span><span class="n">navigationController</span><span class="o">.</span><span class="n">navigationBar</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">height</span><span class="o">]]</span>
    <span class="vi">@table_view</span> <span class="o">=</span> <span class="no">UITableView</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithFrame</span><span class="p">(</span><span class="n">table_frame</span><span class="p">,</span> <span class="ss">style</span><span class="p">:</span><span class="no">UITableViewStylePlain</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@table_view</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div>
<p>＿人人人人人人人人＿<br>
＞　大量のコード　＜<br>
￣Y^Y^Y^Y^Y^Y^Y￣  </p>

<p>でも，恐れないでください．よくみると，全てここまでにやってきたことで構築しています．ただサブビューをまとめたものを追加して，適切なデータに繋いだだけです．</p>

<p><code>rake</code> して確かめてみましょう :</p>

<p><img src="images/3.png" alt="color controller in app"></p>

<p>そういえば，デザインでは賞を期待できないこと，すでにお伝えしてましたよね．</p>

<p>タグを繋げていきましょう．タグをテーブルに格納するのに便利なテーブルビューの <code>delegate</code> メソッドを使うつもりです．それだけで，風変りな部分やコールバックのない，普通のリストになります :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>

    <span class="vi">@table_view</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="nb">self</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">numberOfRowsInSection</span><span class="p">:</span><span class="n">section</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">count</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="ss">cellForRowAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>
    <span class="vi">@reuseIdentifier</span> <span class="o">||=</span> <span class="s2">&quot;CELL_IDENTIFIER&quot;</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="vi">@reuseIdentifier</span><span class="p">)</span> <span class="o">||</span> <span class="k">begin</span>
      <span class="no">UITableViewCell</span><span class="o">.</span><span class="n">alloc</span><span class="o">.</span><span class="n">initWithStyle</span><span class="p">(</span><span class="no">UITableViewCellStyleDefault</span><span class="p">,</span> <span class="ss">reuseIdentifier</span><span class="p">:</span><span class="vi">@reuseIdentifier</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">tags</span><span class="o">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="o">].</span><span class="n">name</span>

    <span class="n">cell</span>
  <span class="k">end</span>
</code></pre></div>
<p>また <code>rake</code> してみると……おおっ！目を引くデータがそこに！</p>

<p><img src="images/4.png" alt="color tags in app"></p>

<p>もう一つやりましょう : 新しいタグを追加できるようにします．その新機能を実装するには 2 つの方法があります，1 つは <code>Tag.create(tag)</code> のようにするか <code>color.tags &lt;&lt; tag</code> をハックする方法，しかし今回はもう 1 つの <code>color.add_tag(tag, &amp;block)</code> の方法でやっていきます．なぜでしょう？なぜなら，その方が色とタグが密結合であることをよく示しているからです．</p>

<p><code>add_tag</code> メソッドは次のようになります :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">add_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="ss">BW</span><span class="p">:</span><span class="ss">:HTTP</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;http://www.colr.org/js/color/</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">/addtag/&quot;</span><span class="p">,</span> <span class="ss">payload</span><span class="p">:</span> <span class="p">{</span><span class="ss">tags</span><span class="p">:</span> <span class="n">tag</span><span class="p">})</span> <span class="k">do</span> <span class="o">|</span><span class="n">response</span><span class="o">|</span>
      <span class="n">block</span><span class="o">.</span><span class="n">call</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div>
<p>ここでは <code>block.call</code> へ何も引数を渡していません．成功か失敗といった情報を渡すこともできますが，この例では別にフォールトトレラントでなくともかまわないので，このようにしました．</p>

<p>さて，<code>ColorController</code> にあるボタンのコールバックの中に <code>add_tag</code> を書きます．タグがサーバーに送信された後，サーバーがタグを本当に受信したか私たちが確認するために，現在のサーバーのデータで手元の色 ( とタグ ) をリフレッシュしたいです．それでは，その処理を <code>when</code> コールバックの中に書いていきましょう :</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">viewDidLoad</span>
    <span class="o">.</span><span class="n">.</span><span class="o">.</span>

    <span class="nb">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">addSubview</span><span class="p">(</span><span class="vi">@add</span><span class="p">)</span>

    <span class="vi">@add</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="no">UIControlEventTouchUpInside</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@add</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="vi">@text_field</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">false</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="vi">@text_field</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">refresh</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">refresh</span>
    <span class="no">Color</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">color</span><span class="o">|</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span>

      <span class="vi">@table_view</span><span class="o">.</span><span class="n">reloadData</span>

      <span class="vi">@add</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
      <span class="vi">@text_field</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div>
<p>一連の処理を追ってみましょう．<code>@add</code> へ <code>UIControlEventTouchUpInside</code> コールバックを追加します．そのコールバックでは <code>color.add_tag</code> を呼び出し，適切な POST リクエストを実行します．そのリクエストが完了したあと，<code>refresh</code> メソッドを呼び出します．そのメソッドは <code>Color.find</code> リクエストを実行し，手元のデータをリセットします．</p>

<p><code>rake</code> して，タグを追加してみます．サクッとできましたか．</p>

<p><img src="images/5.png" alt="adding a tag"></p>

<h2 id="toc_6">まとめ</h2>

<p>ふー，大きな例ですね．ちゃんと設計がなされており，モデルとコントローラ間の責任を分離する一つの方法を示しています．ビューで様々なことをしたり，KVO を追加したり，もっと色々なことができたでしょうが，この程度の例では，それはやり過ぎだと思います．</p>

<p>この例から何を学びましょうか？</p>

<ul>
<li>データを表現するのに，<code>JSON.parse</code> で得られるハッシュを直接使わず，モデルを使います．</li>
<li>モデルの中で URL リクエストを実行します．</li>
<li>コントローラを，コー​​ルバックとユーザーイベントに応答するのに使います．</li>
<li>時間のかかるリクエストが実行されている間，UIを無効にしたり変更して，インターフェイスの応答性を保ちます．</li>
</ul>

          </div>
          <hr />
          <h2>Like it?<small id="spread"> Spread the word</small></h2>
          <div id="social">
            <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="standard"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

            <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://tutorial.rubymotion.jp" data-text="RubyMotion Tutorial: Make iOS Apps With Ruby" data-size="large" data-related="rubymotionjp" data-count="none">Tweet</a>
            <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

            <div class="fb-like" data-href="http://tutorial.rubymotion.jp/" data-send="true" data-width="450" data-show-faces="true"></div>
          </div>
          <hr />
        </div>
      </div>
    </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
  <script src='http://clayallsopp.github.com/rubymotion-tutorial/js/bootstrap.min.js' type="text/javascript"></script>
  <script src='http://clayallsopp.github.com/rubymotion-tutorial/js/chapters.js' type="text/javascript"></script>
  </body>
</html>
